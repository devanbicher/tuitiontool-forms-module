<?php

  /* MAKE SURE NONE OF MY FUNCTIONS CONFLICT WITH MY OTHER MODULE. */

function tuition_tool_forms_menu(){
  $menu_items = array();

  $menu_items['admin/content/tuition_tool_forms'] = array(
       'title' => 'Tuition Tool Forms',
       'description' => 'Landing Page for the Forms',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_landing'),
       'access arguments' => array('access default landing'),
							  );

  $menu_items['admin/content/tuition_tool_forms/american_forms'] = array(
       'title' => 'American Studies Forms',
       'description' => 'Generate the American Studies TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access american defaults'),
							  );
  $menu_items['admin/content/tuition_tool_forms/biology_forms'] = array(
       'title' => 'Biology Forms',
       'description' => 'Generate the Biology TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access bio defaults'),
							  );
    $menu_items['admin/content/tuition_tool_forms/chemistry_forms'] = array(
       'title' => 'Chemistry Forms',
       'description' => 'Generate the Chemistry TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access chem defaults'),
							  );
    //DO I NEED A FORM FOR THE 'COLLEGE' AID TYPE?
    $menu_items['admin/content/tuition_tool_forms/ees_forms'] = array(
       'title' => 'EES Forms',
       'description' => 'Generate the EES TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access ees defaults'),
							  );
  $menu_items['admin/content/tuition_tool_forms/epd_forms'] = array(
       'title' => 'EPD Forms',
       'description' => 'Generate the EPD TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access epd defaults'),
							  );
    $menu_items['admin/content/tuition_tool_forms/english_forms'] = array(
       'title' => 'English Forms',
       'description' => 'Generate the English TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access english defaults'),
							  );
  $menu_items['admin/content/tuition_tool_forms/history_forms'] = array(
       'title' => 'History Forms',
       'description' => 'Generate the History TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access history defaults'),
							  );
  $menu_items['admin/content/tuition_tool_forms/math_forms'] = array(
       'title' => 'Math Forms',
       'description' => 'Generate the Math TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access math defaults'),
							  );
  //DO I NEED THE MISCELLANEOUS AID TYPE?
    $menu_items['admin/content/tuition_tool_forms/physics_forms'] = array(
       'title' => 'Physics Forms',
       'description' => 'Generate the Physics TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access physics defaults'),
							  );
    $menu_items['admin/content/tuition_tool_forms/polisci_forms'] = array(
       'title' => 'Political Science Forms',
       'description' => 'Generate the Political Science TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access polisci defaults'),
							  );
  $menu_items['admin/content/tuition_tool_forms/psychology_forms'] = array(
       'title' => 'Psychology Forms',
       'description' => 'Generate the Psychology TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access psych defaults'),
							  );
  $menu_items['admin/content/tuition_tool_forms/socanthro_forms'] = array(
       'title' => 'SocAnthro Forms',
       'description' => 'Generate the Sociology/Anthropology TA/GA Appointment Form',
       'page callback' => 'drupal_get_form',
       'page arguments' => array('tuition_tool_forms_generating_form'),
       'access arguments' => array('access socanth defaults'),
							  );
  return $menu_items;
  }


function get_years_for_forms(){
  //This function just generates all of the available academic years
  $years = array();
  
  $ent_query = new EntityFieldQuery();
  //new entity query to get the years
  $ent_query->entityCondition('entity_type','taxonomy_term')
    ->entityCondition('bundle','academic_year');

  $match_ents = $ent_query->execute(); //execute the query
  
  foreach($match_ents['taxonomy_term'] as $myent){
    $match_ids[] = $myent->tid; //make a list of matching term ids
  }
  $load_years = entity_load('taxonomy_term',$match_ids); //load the objects into an array
  
  foreach($load_years as $curyear){
    $years[$curyear->tid] = $curyear->name; //make an array with a list of year name and taxonomy term id
  }

  arsort($years);
  return $years;
}

function get_terms_for_forms($year){
  //need to use a query function to get terms for the current year.

  $terms = array();

  $ent_query = new EntityFieldQuery;

  $ent_query->entityCondition('entity_type','taxonomy_term')
    ->entityCondition('bundle','termcodes')
    ->fieldCondition('field_academic_year','tid',$year,'=');
  
  $match_ents = $ent_query->execute();

  foreach($match_ents['taxonomy_term'] as $myent){
    $match_ids[] = $myent->tid;
  }
  $load_terms = entity_load('taxonomy_term',$match_ids);

  uasort($load_terms,'sort_terms_by_code');  //This function is in the tuition tool module
  foreach($load_terms as $curterm){
    $terms[$curterm->tid] = $curterm->name;
  }

  return $terms;
}

function get_dept_ents_from_url($form_url){
  //only used in get_students

  $dept_forms_array = explode('/',$form_url);
  $dept = explode('_forms',$dept_forms_array[4]);

  switch ($dept[0]){
  case 'american':
    return array('american_aid_entry','american_aid_type');
    break;
  case 'biology':
    return array('bio_aid_entry','bio_aid_type');
    break;
  case 'chemistry':
    return array('chem_aid_entry','chem_aid_type');
    break;
  case 'ees':
    return array('ees_aid_entry','ees_aid_type');
    break;
  case 'english':
    return array('english_aid_entry','english_aid_type');
    break;
  case 'epd':
    return array('epd_aid_entry','epd_aid_type');
    break;
  case 'history':
    return array('history_aid_entry','history_aid_type');
    break;
  case 'math':
    return array('math_aid_entry','math_aid_type');
    break;
  case 'physics':
    return array('physics_aid_entry','physics_aid_type');
    break;
  case 'polisci':
    return array('polisci_aid_entry','polisci_aid_type');
    break;
  case 'psychology':
    return array('psych_aid_entry','psych_aid_type');
    break;
  case 'socanthro':
    return array('socanth_aid_entry','socanth_aid_type');
    break;
  default:
    return array('misc_aid_entry','misc_aid_type');
  }
}

function get_dept_title_from_url($form_url){
  $dept_forms_array = explode('/',$form_url);
  $dept = explode('_forms',$dept_forms_array[4]);

  switch ($dept[0]){
  case 'american':
    return 'American Studies';
    break;
  case 'biology':
    return 'Biological Sciences';
    break;
  case 'chemistry':
    return 'Chemistry';
    break;
  case 'ees':
    return 'Earth and Environmental Sciences';
    break;
  case 'english':
    return 'English';
    break;
  case 'epd':
    return 'Environmental Policy';
    break;
  case 'history':
    return 'History';
    break;
  case 'math':
    return 'Mathematics';
    break;
  case 'physics':
    return 'Physics';
    break;
  case 'polisci':
    return 'Political Science';
    break;
  case 'psychology':
    return 'Psychology';
    break;
  case 'socanthro':
    return 'Sociology';
    break;
  default:
    return array('misc_aid_entry','misc_aid_type');
  }
}

function get_students($term,$form_url,$aid_nid,$stipendtuition){
  $dept_ents = get_dept_ents_from_url($form_url);
  $entry=$dept_ents[0];
  $aid=$dept_ents[1];

  $students = array();

  //NOW DO A FIELD QUERY ON THE AID ENTRY AND RETURN A LIST OF RELEVANT VALUES INDEXED BY THE NID
  $entry_query = new EntityFieldQuery;
  $entry_query-> entityCondition('entity_type','node')
    ->entityCondition('bundle',$entry)
    ->propertyCondition('status',NODE_PUBLISHED)
    ->fieldCondition('field_term','tid',$term,'=')
    ->fieldCondition('field_aid_type','target_id',$aid_nid,'=');
  
  if($stipendtuition == 1){
    $entry_query->fieldCondition('field_tuition','value',0,'>');
  }
  else{
    //STIPEND IS THIS REQUIRED? IT FILTERS OUT STIPEND < 0
    $entry_query->fieldCondition('field_stipend','value',0,'>');
  }

  
  $match_entries = $entry_query->execute();

  $load_entries = entity_load('node',array_keys($match_entries['node']));
  
  foreach($load_entries as $curentry){
    $effort = !empty($curentry->field_effort['und'][0]['value']) ? $curentry->field_effort['und'][0]['value'] : 0;
    $periods = !empty($curentry->field_pay_periods['und'][0]['value']) ? $curentry->field_pay_periods['und'][0]['value'] : 0;
    $tuition = !empty($curentry->field_tuition['und'][0]['value']) ? '$'.number_format($curentry->field_tuition['und'][0]['value'],2,'.',',') : 0;
    $stipend = !empty($curentry->field_stipend['und'][0]['value']) ? '$'.number_format($curentry->field_stipend['und'][0]['value'],2,'.',',') : 0;

    $students[$curentry->nid] = array(
      'last' => $curentry->field_student_last_name['und'][0]['value'],
      'first' => $curentry->field_student_first_name['und'][0]['value'],
      'account' => $curentry->field_account_number['und'][0]['value'],
      //below here the values aren't required, for now.      
      'stipend' => $stipend,
      'effort' => $effort,
      'periods' => $periods, 
      'tuition' => $tuition,
				      );
  }

  return $students;
}

function get_aid_types_for_form($year, $form_url){
  $dept_ents = get_dept_ents_from_url($form_url);
  $aid_bundle = $dept_ents[1];

  $aid_list = array();

  $aid_query = new EntityFieldQuery;
  $aid_query-> entityCondition('entity_type','node')
    ->entityCondition('bundle',$aid_bundle)
    ->propertyCondition('status',NODE_PUBLISHED)
    ->fieldCondition('field_term_year','tid',$year,'=');

  $match_aid_query = $aid_query->execute();
  
  $loadedents= entity_load('node',array_keys($match_aid_query['node']));
  
  foreach($loadedents as $curaid){
    $aid_list[$curaid->nid] = $curaid->title;
  }
    
  return $aid_list;
}


function tuition_tool_forms_landing($form, &$form_state){
  $form['landing_markup'] = array(
				  '#markup'=>'<h1>This is simply a landing page for the other form generating pages to branch out from.  This page is purposefully blank</h1>');

  return system_settings_form($form);
}


function tuition_tool_forms_generating_form($form, &$form_state){
  $default_year = variable_get('default_year');

  $formyears = get_years_for_forms(); //This will stay, some of the other variables will change.

  $blank_header = array('meh'=>'PLEASE SELECT A TERM AND AID TYPE TO GENERATE A LIST OF STUDENTS FROM WHICH YOU CAN GENERATE YOUR FORM');
  $blank_table = array();

  $header = array(
		  'last' => 'Last Name',
		  'first' => 'First Name',
		  'account' => 'Account',
		  'effort' => 'Effort',
		  'periods' => 'Pay Periods',
		  'stipend' => 'Stipend',
		  'tuition' => 'Tuition'
		  );

  $form['set_ta_ga_actions'] = array(
	  '#type' => 'actions',
	  '#weight' => -10,
					  );
  
  $form['set_ta_ga_actions']['set_form_year'] = array(
	'#type' => 'select',						
	'#title' => t('FIRST: Please select the year from which to generate this form'),
	'#options' => $formyears,
	'#required' => TRUE,
	'#default_value' => variable_get('default_year'), //THIS IS one reason WHY TUITION TOOL MODULE IS REQUIRED.
	'#ajax' => array(
			 'callback' => 'alter_term_choices',
			 'wrapper' => 'term-choices-list',
			 'method' => 'replace',
			 'effect' => 'fade'),	
						      );
  
  $form['term_select_field_set'] = array(
	 '#type' => 'fieldset',
	 '#prefix' => '<div id="term-choices-list">',
	 '#suffix' => '</div>',
	 '#weight' => -9,
					 );

  $form['term_select_field_set']['select_term'] = array(
	'#type' => 'select',
	'#weight' => -5,
	'#title' => t('SECOND: Please select Term from which to generate forms'),
	'#required' => TRUE,
	'#options' => !empty($form_state['values']['set_form_year']) ? get_terms_for_forms($form_state['values']['set_form_year']) : get_terms_for_forms($default_year),
	'#ajax' => array(
			 'callback' => 'get_aid_type_list',
			 'wrapper' => 'select-aid-type-list',
			 'method' => 'replace',
			 'effect' => 'fade'),
							);
  $form['term_select_field_set']['select_aid_type'] = array(
	'#type' => 'fieldset',
	'#weight' => -3,
	'#prefix' => '<div id="select-aid-type-list">',
	'#suffix' => '</div>',
							    );
  $form['term_select_field_set']['select_aid_type']['aid_type_select_list'] = array(
	'#type' => 'select',
	'#weight' => -4,
	'#title' => t('THIRD: Please Select the aid types from which to generate your form'),
	//'#multiple' => TRUE,
	'#required' => TRUE,
	'#options' => !empty($form_state['values']['set_form_year']) ? get_aid_types_for_form($form_state['values']['set_form_year'], $form_state['complete form']['#action']) : array('empty-list'),
	'#ajax' => array(
			 'callback' => 'create_student_choices',
			 'wrapper' => 'select-students-table',
			 'method' => 'replace',
			 'effect' => 'fade'),
											      );
    $form['term_select_field_set']['select_aid_type']['tuition_or_stipend'] = array(
        '#type' => 'radios',
	'#title' => t('FOURTH: Choose which Field, Tuition or Stipend, Students must have a value for to be in the list'),
	'#weight' => -2,
	'#options' => array(0 => t('Stipend > 0'), 1 => t('Tuition > 0')),
	'#default_value' => 0,
	'#description' => t('Please choose if the list of students should be populated with students with stipend > 0 (for TA/GA Appointment list or Payroll assignment form) or Tuition > 0 (for Tuition Award form)'),
	'#ajax' => array(
			 'callback' => 'create_student_choices',
			 'wrapper' => 'select-students-table',
			 'method' => 'replace',
			 'effect' => 'fade'),
							       );
  $form['term_select_field_set']['select_aid_type']['select_ta_ga_students'] = array(
	'#type' => 'actions',
	'#weight' => 0,
	'#prefix' => '<div id="select-students-table">',
	'#suffix' => '</div>',
					 );
  $form['term_select_field_set']['select_aid_type']['select_ta_ga_students']['choose_students_table'] = array(
	'#type' => 'tableselect',
	'#header' => !empty($form_state['values']['select_term']) ? $header : $blank_header,
	'#options' =>(!empty($form_state['values']['select_term']) && !empty($form_state['values']['aid_type_select_list'])) ? 
	get_students($form_state['values']['select_term'],$form_state['complete form']['#action'],$form_state['values']['aid_type_select_list'],$form_state['values']['tuition_or_stipend']) : $blank_table,
	'#weight' => 10,
								  );
  $form['term_select_field_set']['dev_notes'] = array(
        '#type' => 'markup',
	'#markup' => '',
	'#weight' => -10,
			     );
  /*FORM GENERATING BUTTONS!*/
  $form['form_building_buttons'] = array(
	'#title' => 'Form Generating buttons',
	'#type' => 'fieldset',
	'#weight' => -5,
					 );
  $form['form_building_buttons']['build_appointment_list'] = array(
        '#type' => 'submit',
	'#value' => 'Build TA/GA Appointment List',
	'#submit' => array('tuition_tool_forms_ta_ga_submit'),
	'#weight' => -5,
								   );
  $form['form_building_buttons']['generate_payroll_asignment_form'] = array(
        '#type' => 'submit',
	'#value' => 'Generate Payroll Asignment Forms',
	'#submit' => array('tuition_tool_forms_payroll_assignment'),
	'#weight' => -4,
								   );
  $form['form_building_buttons']['generate_tuition_award_form'] = array(
	'#type' => 'submit',
	'#value' => 'Generate Tuition Award Forms',
	'#submit' => array('tuition_tool_forms_tuition_award'),
	'#weight' => -3,
									);
								   
  //This space below here generates the form. 
  if(!empty($form_state['values']['choose_students_table'])){
    $students_selected = FALSE;//This variable and following for loop makes sure this doesn't activate unless students are selected
    foreach($form_state['values']['choose_students_table'] as $value){
      if($value > 0){
	$students_selected = TRUE;
	break;
      }
    }
    if($students_selected){    
      drupal_add_css(drupal_get_path('module','tuition_tool_forms').'/tuition_tool_forms.css');
      //removes the form stuff to only display the Appointment List
      unset($form['set_ta_ga_actions']);
      unset($form['term_select_field_set']);
      //unset($form['select_ta_ga_students']);
      //unset($form['build_appointment_list']);
      unset($form['form_building_buttons']);
      unset($form['dev_notes']);
      
      $student_list = array();
      
      $term_id = $form_state['values']['select_term'];
      
      foreach( $form_state['values']['choose_students_table'] as $stud_nid){
	if($stud_nid > 0){
	  $student_list[] = $stud_nid;
	}
      }
      $form['generated_appointment_list'] = array(
						  '#markup' => generate_appointment_html($student_list,$term_id,$form_state['complete form']['#action'],$form_state['values']['aid_type_select_list'])
						  );
    }
  }
  
  //return system_settings_form($form); this puts the save config button on the bottom.
  return $form;
}

function get_aid_type_list($form, &$form_state){
  return $form['term_select_field_set']['select_aid_type'];
}

function create_student_choices($form, $form_state){
  return $form['term_select_field_set']['select_aid_type']['select_ta_ga_students'];
}

function alter_term_choices($form,$form_state){
  return $form['term_select_field_set'];
}

//function get_position_num($account){
function get_position_num($account,$aid_nid){
  $load_aid_type = entity_load('node',array($aid_nid));
  //get the aid title for the wierd departments
  $aid_title = strtolower(trim($load_aid_type[$aid_nid]->title));
  switch ($account){
  case '211105': 
    $position = 'GT9960'; //Bio
    break;
  case '211310':
    $position = 'GT9950'; //Chem
    break;
  case '211125':
    $position = 'GT9940'; //EES
    break;
  case '211115':
    //English
    if($aid_title=='ta'){
      $position = 'GT9930';
    }
    elseif($aid_title=='senior ta'){
      $position = 'GT9940';
    }
    else{
      $position = '';
    }
    break;
  case '211135':
    $position = 'GT9910'; //History
    break;
  case '211145':
    //Math
    if($aid_title == 'grader' || $aid_title == 'graders'){
      $position = 'GT9890';
    }
    else{
      $position = 'GT9900';
    }
    break;
  case '211340':
    $position = 'GT9880';//Physics
    break;
  case '211130':
    $position = 'GT9870';//PoliSci
    break;
  case '211165':
    //Psych
    if($aid_title == 'ta'){
      $position = 'GT9850';
    }
    else{
      $position = 'GT9860';
    }
    break;
  case '211175':
    $position = 'GT9840'; //Socanthro
    break;
  case '211189':
    $position = 'GT9820'; //EI (EPD?)
    break;
  default:
    $position = '';
  }

      return $position;
}

function generate_appointment_html($stud_list,$term_id,$form_url,$aid_nid){
  $accntend = 61510;
  $dept = get_dept_title_from_url($form_url);
  $list_html = '';

  $term_load = entity_load('taxonomy_term',array($term_id));
  
  $term_ent_vals = array_values($term_load);
  $term_ent = $term_ent_vals[0];
  
  $term_code = $term_ent->field_banner_term_code['und'][0]['value'];

  $entities = entity_load('node',$stud_list);

  $total_stipend = 0;
  $total_rate = 0;
  $counter = 0;
  $table_html = '';
  
  //I NEED TO CHECK TO MAKE SURE THE ACCOUNT NUMBER IS THE SAME
  foreach($entities as $curentry){
    if($counter == 0){
      $account = $curentry->field_account_number['und'][0]['value']; //set the account number to make sure they are all the same
      //Position # from account #
      $position = get_position_num($account,$aid_nid);
    }
    else{
      $cur_account = $curentry->field_account_number['und'][0]['value'];
      if($cur_account != $account){
	return "<h1>Some of the enrties you've selected have different account numbers, they must ALL have the same account number for this form</h1>";
      }
    }

    //If I make these other fields required when entering stipend I don't need to be worried about there not being data in a field.
    $name = $curentry->field_student_last_name['und'][0]['value'].', '.$curentry->field_student_first_name['und'][0]['value'];
    $id =  $curentry->field_lin['und'][0]['value'];
    $phone =  $curentry->field_phone['und'][0]['value'];
    $stipend = $curentry->field_stipend['und'][0]['value'];
    //Values below here might not be required until I update the tuition tool code to make them
    //in case I make the date values required when entering stipend:
    //$start = $curentry->field_aid_date['und'][0]['value'];
    //$end = $curentry->field_aid_date['und'][0]['value2'];
    $start =  !empty($curentry->field_aid_date['und'][0]['value']) ? $curentry->field_aid_date['und'][0]['value'] : 0;
    $end = !empty($curentry->field_aid_date['und'][0]['value2']) ? $curentry->field_aid_date['und'][0]['value2'] : 0;
    $start_date = new DateTime($start);
    $end_date = new DateTime($end);

    $effort = !empty($curentry->field_effort['und'][0]['value']) ? $curentry->field_effort['und'][0]['value'] : '--';
    $periods = !empty($curentry->field_pay_periods['und'][0]['value']) ? $curentry->field_pay_periods['und'][0]['value'] : '--';
    $rate = !empty($curentry->field_pay_periods['und'][0]['value']) ? $stipend/$periods : 0;
    //if I make effort and periods required when entering stipend:
    //$effort = $curentry->field_effort['und'][0]['value'];
    //$periods = $curentry->field_pay_periods['und'][0]['value'];
    //$rate = $stipend/$periods;

    //Totals
    $total_stipend = $total_stipend + $stipend;
    $total_rate = $total_rate + $rate;
    //create the row
    $thisrow = '<tr><td>'.$name.'</td><td>'.$id.'</td><td>'.$phone.'</td><td>'.$start_date->format('m-d-Y').'</td><td>'
      .$end_date->format('m-d-Y').'</td><td>'.$effort.'</td><td>'.$periods.'</td><td>$'
      .number_format($rate,2,'.',',').'</td><td>$'.number_format($stipend,2,'.',',').'</td></tr>';

    //Add the row to the list
    $table_html = $table_html.$thisrow;
    $counter += 1;
  }

  $list_top_html = '<div class="appointment-list-page-wrapper">
                    <div class="appointment-list-inner-wrapper">
                    <div class="appointment-list-header">
                    <h1 class="appointment-list-head-text">TA/GA Appointment List</h1>
                    <div class="header-line-1 clearfix"><div class="term-space"><p>Term: <span class="term-id">'.$term_code.'</span></p></div>
                    <div class="account-space"><p>'.$account.'-'.$accntend.'</p></div></div>
                    <div class="header-line-2 clearfix"><div class="department-space"><p>Department:  <span class="department-name">'.$dept.'</span></p></div>
                    <div class="account-name"><p>Account</p></div></div></div>';

  $list_html = $list_html.$list_top_html;

  $table_header = '<table class="appointment-table"><tr class="table-header">
                           <th>Employee Name</th>
                           <th>Lehigh ID</th>
                           <th>Phone Ext.</th>
                           <th>Start Date</th>
                           <th>End Date</th>
                           <th>Percent Effort</th>
                           <th>Pay Periods</th>
                           <th>Periodic Rate</th>
                           <th>Total Stipend</th>                       
               </tr>';
  
  $list_html = $list_html.$table_header;
  $list_html = $list_html.$table_html;

  //Don't forget to style this final row differently
  $table_footer = '<tr class="last-row"><td></td><td></td><td></td><td></td><td></td><td></td>
                   <td class="final-totals"><strong>Totals:</strong></td><td class="final-totals"> $'.number_format($total_rate,2,'.',',')
                   .'</td><td class="final-totals"> $'.number_format($total_stipend,2,'.',',').'</td></tr></table>';

  $list_html = $list_html.$table_footer;

  $below_table = '<div class="sub-table">
                  <div class="sub-table-1 clearfix"><p>*Please use full legal name</p></div>
                  <div class="sub-table-2 clearfix"><p>For internal use only</p></div>
                  <div class="sub-table-3 clearfix"><p id="tkl">TKL</p><div class="internal-use-line"></div>
                                                    <div class="accnt-exec-line"><p>Account Executive</p></div>
                                                    <div class="date-line"><p>Date</p></div></div>
                  <div class="sub-table-4 clearfix"><p id="ddu">DDU</p><div class="internal-use-line"></div></div>
                  <div class="sub-table-5 clearfix"><p id="position-num">Position #</p><div class="internal-use-line"><p> '.$position.'</p></div></div>
                  <div class="sub-table-6 clearfix"><div class="no-status-change"><p>This form may not be used to report</p>
                                                                                  <p>change in existing status</p></div>
                                                    <div class="initials-table-div">
                                                    <table class="initials-table"><tr><th class="initials-initials">Initials</th>
                                                               <th class="initials-date">Date</th>
                                                               <th class="initials-rout">Routing</th></tr>
                                                    <tr><td></td><td></td><td>College Dean</td></tr>
                                                    <tr><td></td><td></td><td>Graduate Dean</td></tr>
                                                    <tr><td></td><td></td><td>Vice President</td></tr>
                                                    </table></div></div>
                 <div class="sub-table-last"><p>After obtaining signatures, return form to payroll office.</p></div></div>';

  $list_html = $list_html.$below_table;

  $list_html = $list_html.'</div></div>';


    return $list_html;
}

function tuition_tool_forms_ta_ga_submit($form, &$form_state){
  $form_state['rebuild'] = TRUE;
}

function tuition_tool_forms_payroll_assignment($form, &$form_state){
  $form_state['rebuild'] = FALSE;
  
  dsm($form_state);

  //DONT FORGET EACH STUDENT GETS THEIR OWN FORM!!

  $department = get_dept_title_from_url($form_state['complete form']['#action']);

  $entities = entity_load('node',$form_state['values']['choose_student_table']);
  
  $header_info = array();
  $accounts = array();

  foreach($entities as $curentry){
    $first_name =$curentry->field_student_first_name['und'][0]['value'];
    $last_name = $curentry->field_student_last_name['und'][0]['value'];
    $id =  $curentry->field_lin['und'][0]['value'];
    $phone =  $curentry->field_phone['und'][0]['value'];
    $stipend = $curentry->field_stipend['und'][0]['value'];
    $location = $curentry->field_check_location['und'][0]['value'];
    $account = $curentry->field_account_number['und'][0]['value'];
    //non-required fields
    //REPLACE MY NAME IN THIS VARIABLE!!
    $contact = !empty($curentry->field_contact['und'][0]['value']) ? $curentry->field_contact['und'][0]['value'] : 'Devan Bicher'; 
    $start =  !empty($curentry->field_aid_date['und'][0]['value']) ? $curentry->field_aid_date['und'][0]['value'] : 0;
    $end = !empty($curentry->field_aid_date['und'][0]['value2']) ? $curentry->field_aid_date['und'][0]['value2'] : 0;
    $start_date = new DateTime($start);
    $end_date = new DateTime($end);
    $effort = !empty($curentry->field_effort['und'][0]['value']) ? $curentry->field_effort['und'][0]['value'] : '--';
    $periods = !empty($curentry->field_pay_periods['und'][0]['value']) ? $curentry->field_pay_periods['und'][0]['value'] : '--';
    $rate = !empty($curentry->field_pay_periods['und'][0]['value']) ? $stipend/$periods : 0;


  } 

}

function generate_payroll_single_pdf($pdf_info){
}

function tuition_tool_forms_tuition_award($form, &$form_state){
}

function generate_tuition_single_pdf($pdf_info){
}

function present_filled_pdf($pdf){
}
